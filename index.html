<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EMOTHI</title>
    <meta name="description" content="感情×スイッチ＝エモッチ。今の気持ちを世界と共有しよう。">
    <meta property="og:url" content="https://negurabeat.github.io/emothi-app/" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="EMOTHI (エモッチ)" />
    <meta property="og:description" content="今の感情をスイッチで送信。世界中の「今」の感情が見えるアプリ。" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Zen+Kaku+Gothic+New:wght@400;700;900&family=Inter:wght@400;700&display=swap');

        body {
            font-family: 'Zen Kaku Gothic New', sans-serif;
            background-color: #121212;
            color: #ffffff;
            touch-action: manipulation;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- 光るエフェクト --- */
        @keyframes flash-joy { 0% { box-shadow: 0 0 20px #FFD700; background-color: #ffeeb0; transform: scale(0.95); } 100% { box-shadow: none; background-color: #FFD700; transform: scale(1); } }
        @keyframes flash-anger { 0% { box-shadow: 0 0 20px #FF4500; background-color: #ffcccb; transform: scale(0.95); } 100% { box-shadow: none; background-color: #dc2626; transform: scale(1); } }
        @keyframes flash-sorrow { 0% { box-shadow: 0 0 20px #4169E1; background-color: #daeaff; transform: scale(0.95); } 100% { box-shadow: none; background-color: #2563eb; transform: scale(1); } }
        @keyframes flash-pleasure { 0% { box-shadow: 0 0 20px #32CD32; background-color: #d1fae5; transform: scale(0.95); } 100% { box-shadow: none; background-color: #22c55e; transform: scale(1); } }

        .animate-joy { animation: flash-joy 0.2s cubic-bezier(0, 0, 0.2, 1); }
        .animate-anger { animation: flash-anger 0.2s cubic-bezier(0, 0, 0.2, 1); }
        .animate-sorrow { animation: flash-sorrow 0.2s cubic-bezier(0, 0, 0.2, 1); }
        .animate-pleasure { animation: flash-pleasure 0.2s cubic-bezier(0, 0, 0.2, 1); }

        /* ボタン共通スタイル & 波動 */
        .emotion-btn {
            transition: all 0.1s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: visible !important;
            border: 2px solid transparent;
        }
        .emotion-btn:active { transform: scale(0.95); }
        .emotion-btn::after {
            content: ''; position: absolute; top: 50%; left: 50%; width: 100%; height: 100%;
            background: transparent; border-radius: 16px; transform: translate(-50%, -50%) scale(1);
            opacity: 0; z-index: -1; pointer-events: none;
        }

        /* 波動 (自分用: 強) */
        @keyframes wave-joy { 0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.8); transform: translate(-50%, -50%) scale(1); opacity: 0.8; } 100% { box-shadow: 0 0 20px 20px rgba(255, 215, 0, 0); transform: translate(-50%, -50%) scale(1.5); opacity: 0; } }
        @keyframes wave-anger { 0% { box-shadow: 0 0 0 0 rgba(255, 69, 0, 0.8); transform: translate(-50%, -50%) scale(1); opacity: 0.8; } 100% { box-shadow: 0 0 20px 20px rgba(255, 69, 0, 0); transform: translate(-50%, -50%) scale(1.5); opacity: 0; } }
        @keyframes wave-sorrow { 0% { box-shadow: 0 0 0 0 rgba(65, 105, 225, 0.8); transform: translate(-50%, -50%) scale(1); opacity: 0.8; } 100% { box-shadow: 0 0 20px 20px rgba(65, 105, 225, 0); transform: translate(-50%, -50%) scale(1.5); opacity: 0; } }
        @keyframes wave-pleasure { 0% { box-shadow: 0 0 0 0 rgba(50, 205, 50, 0.8); transform: translate(-50%, -50%) scale(1); opacity: 0.8; } 100% { box-shadow: 0 0 20px 20px rgba(50, 205, 50, 0); transform: translate(-50%, -50%) scale(1.5); opacity: 0; } }

        .animate-joy::after { animation: wave-joy 0.5s ease-out !important; }
        .animate-anger::after { animation: wave-anger 0.5s ease-out !important; }
        .animate-sorrow::after { animation: wave-sorrow 0.5s ease-out !important; }
        .animate-pleasure::after { animation: wave-pleasure 0.5s ease-out !important; }

        /* 波動 (世界用: 中) */
        @keyframes wave-world-joy { 0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.6); transform: translate(-50%, -50%) scale(1); opacity: 0.6; } 100% { box-shadow: 0 0 15px 15px rgba(255, 215, 0, 0); transform: translate(-50%, -50%) scale(1.3); opacity: 0; } }
        @keyframes wave-world-anger { 0% { box-shadow: 0 0 0 0 rgba(255, 69, 0, 0.6); transform: translate(-50%, -50%) scale(1); opacity: 0.6; } 100% { box-shadow: 0 0 15px 15px rgba(255, 69, 0, 0); transform: translate(-50%, -50%) scale(1.3); opacity: 0; } }
        @keyframes wave-world-sorrow { 0% { box-shadow: 0 0 0 0 rgba(65, 105, 225, 0.6); transform: translate(-50%, -50%) scale(1); opacity: 0.6; } 100% { box-shadow: 0 0 15px 15px rgba(65, 105, 225, 0); transform: translate(-50%, -50%) scale(1.3); opacity: 0; } }
        @keyframes wave-world-pleasure { 0% { box-shadow: 0 0 0 0 rgba(50, 205, 50, 0.6); transform: translate(-50%, -50%) scale(1); opacity: 0.6; } 100% { box-shadow: 0 0 15px 15px rgba(50, 205, 50, 0); transform: translate(-50%, -50%) scale(1.3); opacity: 0; } }

        .animate-world-joy::after { animation: wave-world-joy 0.8s ease-out; }
        .animate-world-anger::after { animation: wave-world-anger 0.8s ease-out; }
        .animate-world-sorrow::after { animation: wave-world-sorrow 0.8s ease-out; }
        .animate-world-pleasure::after { animation: wave-world-pleasure 0.8s ease-out; }

        .animate-joy::after { animation: wave-joy 0.5s ease-out !important; }
        .animate-anger::after { animation: wave-anger 0.5s ease-out !important; }
        .animate-sorrow::after { animation: wave-sorrow 0.5s ease-out !important; }
        .animate-pleasure::after { animation: wave-pleasure 0.5s ease-out !important; }

        .emotion-btn {
            transition: all 0.1s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: visible !important;
        }

        /* タブのアクティブスタイル */
        .tab-active {
            background-color: rgba(255, 255, 255, 0.1);
            color: #fff;
            border-bottom: 2px solid #fff;
        }
        .tab-inactive {
            color: #6b7280;
            border-bottom: 2px solid transparent;
        }

        /* --- 吹き出しスタイル --- */
        .bubble-base {
            position: absolute;
            background-color: white;
            color: black;
            padding: 10px 14px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            z-index: 20;
            width: max-content;
            max-width: 240px;   
            min-width: 80px;    
            line-height: 1.4;
            text-align: center;
            opacity: 0; 
            pointer-events: none;
            transition: opacity 0.2s ease, transform 0.2s ease;
        }

        .bubble-visible {
            opacity: 1;
            transform: scale(1);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        @keyframes popIn { 0% { transform: scale(0); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        /* 吹き出しのしっぽ */
        .bubble-tail::after {
            content: '';
            position: absolute;
            bottom: -8px; 
            width: 0;
            height: 0;
            border-style: solid;
        }

        /* 左側配置 */
        .bubble-left {
            right: 20px; 
            bottom: 50px;
            transform-origin: bottom right;
            border-bottom-right-radius: 4px; /* 角を少し鋭く */
        }
        .bubble-left::after {
            right: 12px;
            border-width: 12px 10px 0 0; /* 右上が直角に近い形 */
            border-color: white transparent transparent transparent;
        }

        /* 右側配置 */
        .bubble-right {
            left: 20px;
            bottom: 50px;
            transform-origin: bottom left;
            border-bottom-left-radius: 4px;
        }
        .bubble-right::after {
            left: 12px;
            border-width: 12px 0 0 10px;
            border-color: white transparent transparent transparent;
        }

        /* AIモード */
        .bubble-ai { background-color: #f3e8ff; color: #4c1d95; }
        .bubble-ai.bubble-left::after { border-color: #f3e8ff transparent transparent transparent; }
        .bubble-ai.bubble-right::after { border-color: #f3e8ff transparent transparent transparent; }

        /* ビッグエフェクト */
        .big-effect { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); pointer-events: none; z-index: 50; animation: big-spread 1.5s ease-out forwards; opacity: 0; }
        @keyframes big-spread { 0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; } 20% { opacity: 0.3; } 100% { transform: translate(-50%, -50%) scale(5); opacity: 0; } }

        .ai-sparkle { animation: sparkle 2s infinite; }
        @keyframes sparkle { 0%, 100% { opacity: 1; filter: drop-shadow(0 0 2px #fff); } 50% { opacity: 0.7; filter: drop-shadow(0 0 8px #a855f7); } }
        
        /* 広告スペース（地層風） */
        .stratum-container {
            width: 100%;
            /* max-width: 320px; を削除して親要素(max-w-md)に合わせる */
            margin: 0 auto;
            display: flex;
            flex-direction: column;
        }
        
        .stratum-layer {
            width: 100%;
            height: 40px; /* 各枠の高さ */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px; /* 10px -> 12px */
            font-weight: bold;
            transition: background-color 0.2s;
            cursor: pointer;
        }

        /* 1層目（浅い層） */
        .layer-1 {
            background-color: #292524; /* stone-800 */
            border: 1px dashed #44403c;
            border-bottom: none;
            color: #a8a29e;
            border-radius: 4px 4px 0 0;
        }
        .layer-1:hover { background-color: #363230; }

        /* 2層目（深い層） */
        .layer-2 {
            background-color: #1c1917; /* stone-900 */
            border: 1px dashed #292524;
            color: #78716c;
        }
        .layer-2:hover { background-color: #262220; }
        
        /* コンテンツ地層（さらに深い層） */
        .layer-content {
            background-color: #0c0a09; /* stone-950 */
            border-left: 1px solid #1c1917;
            border-right: 1px solid #1c1917;
            border-bottom: 1px solid #1c1917;
            color: #d6d3d1; 
            padding: 24px;
            font-size: 14px; /* 13px -> 14px */
            line-height: 1.8;
            text-align: left;
            border-radius: 0 0 4px 4px;
        }
        
        .layer-content h3 {
            color: #f5f5f4;
            font-weight: bold;
            font-size: 16px; /* 15px -> 16px */
            margin-top: 16px;
            margin-bottom: 10px;
            border-bottom: 1px solid #44403c;
            padding-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .layer-content p {
            margin-bottom: 16px;
        }
        
        .layer-content strong {
            color: #ffffff;
        }

        /* 地面ライン */
        .ground-line {
            width: 80%;
            height: 2px;
            background-color: #44403c;
            margin: 0 auto 2px auto;
            border-radius: 2px;
            opacity: 0.5;
        }

        /* --- 棒人間の歩行アニメーション --- */
        @keyframes walk-body {
            0%, 100% { transform: translateX(0) rotate(0deg); }
            25% { transform: translateX(5px) rotate(2deg); }
            75% { transform: translateX(-5px) rotate(-2deg); }
        }
        /* SVG内の足用クラス */
        .leg-left-anim {
            animation: leg-swing 1s infinite alternate ease-in-out;
            transform-origin: 50px 80px; /* 股関節 */
        }
        .leg-right-anim {
            animation: leg-swing 1s infinite alternate-reverse ease-in-out;
            transform-origin: 50px 80px;
        }
        @keyframes leg-swing {
            from { transform: rotate(-15deg); }
            to { transform: rotate(15deg); }
        }
        
        /* 全体が左右に歩くコンテナ */
        .walker-container {
            width: 40px; /* 基準幅を固定して吹き出しの位置計算を安定させる */
            animation: wander 10s infinite ease-in-out;
        }
        @keyframes wander {
            0%, 100% { transform: translateX(0); }
            30% { transform: translateX(20px); }
            70% { transform: translateX(-20px); }
        }

        /* --- 感情オーラ（パーティクル） --- */
        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            opacity: 0.6;
            pointer-events: none;
            animation: floatUp 3s linear infinite;
        }
        @keyframes floatUp {
            0% { transform: translateY(0) scale(1); opacity: 0.6; }
            100% { transform: translateY(-40px) scale(0); opacity: 0; }
        }

        #share-modal { transition: opacity 0.3s ease; }
    </style>
</head>
<body class="px-1 py-2 safe-area-pb">

    <!-- メインコンテンツラッパー -->
    <div id="capture-area" class="flex flex-col justify-between min-h-[calc(100dvh-60px)] bg-[#121212]">

        <!-- ヘッダー -->
        <header class="flex-none w-full max-w-md mx-auto flex justify-between items-center mb-0.5">
            <div class="flex flex-col">
                <h1 class="text-xl font-bold tracking-wider text-gray-300 font-[Inter] leading-none">EMOTHI</h1>
                <span class="text-xs text-gray-500 tracking-wider font-bold mt-0.5">エモッチ</span>
            </div>
            <div id="header-status" class="text-xs text-gray-500 border border-gray-700 px-2 py-0.5 rounded-full flex items-center">
                <span id="connection-status" class="w-2 h-2 inline-block bg-yellow-500 rounded-full mr-1.5"></span>
                <span id="connection-text" class="font-[Inter]">CONNECTING</span>
            </div>
        </header>

        <!-- メッセージエリア -->
        <div class="flex-none text-center -mb-1 z-10 relative">
            <p class="text-sm text-gray-400 font-bold">今のあなたの気持ちを押してみよう。</p>
            <p class="text-xs text-gray-600 font-[Inter] transform scale-90">Press your current feeling.</p>
        </div>

        <!-- メインスイッチエリア -->
        <main class="flex-none flex items-center justify-center w-full max-w-md mx-auto py-1">
            <div class="grid grid-cols-2 gap-1.5 w-full aspect-square max-h-[30vh]">
                <button id="btn-joy" onclick="handlePress('joy')" class="emotion-btn bg-[#FFD700] text-black rounded-2xl shadow-md group flex flex-col items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mb-0.5 opacity-80 group-hover:scale-105 transition-transform"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" x2="9.01" y1="9" y2="9"/><line x1="15" x2="15.01" y1="9" y2="9"/></svg>
                    <span class="text-2xl font-black mb-0.5 z-10">喜</span><span class="text-[10px] font-bold opacity-60 leading-none mb-0.5">ヨロコビ</span><span class="text-[10px] font-bold tracking-widest font-[Inter] opacity-70 leading-none">JOY</span>
                </button>
                <button id="btn-anger" onclick="handlePress('anger')" class="emotion-btn bg-red-600 text-white rounded-2xl shadow-md group flex flex-col items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mb-0.5 opacity-80 group-hover:scale-105 transition-transform"><circle cx="12" cy="12" r="10"/><path d="M16 16s-1.5-2-4-2-4 2-4 2"/><line x1="9" x2="9.01" y1="9" y2="9"/><line x1="15" x2="15.01" y1="9" y2="9"/></svg>
                    <span class="text-2xl font-black mb-0.5 z-10">怒</span><span class="text-[10px] font-bold opacity-60 leading-none mb-0.5">イカリ</span><span class="text-[10px] font-bold tracking-widest font-[Inter] opacity-70 leading-none">ANGER</span>
                </button>
                <button id="btn-sorrow" onclick="handlePress('sorrow')" class="emotion-btn bg-blue-600 text-white rounded-2xl shadow-md group flex flex-col items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mb-0.5 opacity-80 group-hover:scale-105 transition-transform"><circle cx="12" cy="12" r="10"/><path d="M7.5 11h3"/><path d="M9 11v3"/><path d="M13.5 11h3"/><path d="M15 11v3"/><path d="M9 18c1.5-1 4.5-1 6 0"/></svg>
                    <span class="text-2xl font-black mb-0.5 z-10">哀</span><span class="text-[10px] font-bold opacity-60 leading-none mb-0.5">カナシミ</span><span class="text-[10px] font-bold tracking-widest font-[Inter] opacity-70 leading-none">SORROW</span>
                </button>
                <button id="btn-pleasure" onclick="handlePress('pleasure')" class="emotion-btn bg-green-500 text-white rounded-2xl shadow-md group flex flex-col items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mb-0.5 opacity-80 group-hover:scale-105 transition-transform"><circle cx="12" cy="12" r="10"/><path d="M8 14c0 0 1.5 3.5 4 3.5 2.5 0 4-3.5 4-3.5H8z"/><line x1="9" x2="9.01" y1="9" y2="9"/><line x1="15" x2="15.01" y1="9" y2="9"/></svg>
                    <span class="text-2xl font-black mb-0.5 z-10">楽</span><span class="text-[10px] font-bold opacity-60 leading-none mb-0.5">タノシミ</span><span class="text-[10px] font-bold tracking-widest font-[Inter] opacity-70 leading-none">PLEASURE</span>
                </button>
            </div>
        </main>

        <!-- 集計エリア -->
        <section class="flex-none w-full max-w-md mx-auto bg-gray-800/50 backdrop-blur-sm rounded-xl border border-gray-700 shadow-xl overflow-hidden mb-1 mt-2">
            <div class="flex text-xs font-bold text-center bg-gray-900/50">
                <button onclick="switchTab('world_1h')" id="tab-world-1h" class="flex-1 py-2 tab-active transition-colors leading-tight">
                    いまのせかい <span class="text-[10px] font-normal opacity-70 font-[Inter] block">直近1時間(1H)</span>
                </button>
                <button onclick="switchTab('world_today')" id="tab-world-today" class="flex-1 py-2 tab-inactive transition-colors leading-tight">
                    きょうのせかい <span class="text-[8px] font-normal opacity-70 font-[Inter] block tracking-tighter">今日1日の合計(Day)</span>
                </button>
                <button onclick="switchTab('personal')" id="tab-personal" class="flex-1 py-2 tab-inactive transition-colors leading-tight">
                    いまのあなた <span class="text-[10px] font-normal opacity-70 font-[Inter] block">直近1時間(1H)</span>
                </button>
            </div>
            <div class="p-1.5">
                <p id="data-desc" class="text-xs text-gray-500 text-center mb-1 leading-tight">
                    1時間以内のデータです。 <span class="text-[10px] opacity-70 font-[Inter]">Data from the last hour.</span>
                </p>

                <div class="flex justify-between items-center mb-2 pb-1 border-b border-gray-700/50">
                    <span class="text-sm text-gray-400">合計</span>
                    <div class="flex items-center gap-2">
                        <span id="display-total" class="text-xl font-mono font-bold text-white tracking-tighter">0</span>
                        <div id="live-indicator" class="w-2 h-2 bg-green-500 rounded-full animate-pulse opacity-1"></div>
                    </div>
                </div>
                <div class="grid grid-cols-4 gap-2 text-center">
                    <div class="bg-gray-700/30 rounded py-1.5"><span class="text-sm text-yellow-500 block font-bold">喜</span><span id="display-joy" class="text-lg font-mono text-gray-300">0</span></div>
                    <div class="bg-gray-700/30 rounded py-1.5"><span class="text-sm text-red-500 block font-bold">怒</span><span id="display-anger" class="text-lg font-mono text-gray-300">0</span></div>
                    <div class="bg-gray-700/30 rounded py-1.5"><span class="text-sm text-blue-500 block font-bold">哀</span><span id="display-sorrow" class="text-lg font-mono text-gray-300">0</span></div>
                    <div class="bg-gray-700/30 rounded py-1.5"><span class="text-sm text-green-500 block font-bold">楽</span><span id="display-pleasure" class="text-lg font-mono text-gray-300">0</span></div>
                </div>
            </div>
        </section>

        <!-- SNSシェア (2段組み: テキスト + 画像) -->
        <div id="share-buttons-area" class="flex-none w-full max-w-md mx-auto mb-2 px-2 flex flex-col gap-2">
            <!-- テキスト系シェア -->
            <div class="flex gap-2 justify-center w-full">
                <button onclick="shareTo('x')" class="flex-1 bg-black border border-gray-700 hover:bg-gray-900 text-white py-2.5 rounded-lg font-bold transition-colors flex items-center justify-center gap-1.5"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg><span class="text-sm font-[Inter]">Post</span></button>
                <button onclick="shareTo('line')" class="flex-1 bg-[#06C755] hover:bg-[#05b34c] text-white py-2.5 rounded-lg font-bold transition-colors flex items-center justify-center gap-1.5"><span class="text-sm font-[Inter]">LINE</span></button>
                <button onclick="shareTo('threads')" class="flex-1 bg-[#1a1a1a] border border-gray-600 hover:bg-gray-800 text-white py-2.5 rounded-lg font-bold transition-colors flex items-center justify-center gap-1.5"><span class="text-sm font-[Inter]">Threads</span></button>
            </div>
            <!-- 画像系シェア -->
            <div class="flex gap-2 justify-center w-full">
                <button onclick="handleImageShare('instagram')" class="flex-1 bg-gradient-to-r from-purple-500 to-pink-500 hover:opacity-90 text-white py-2.5 rounded-lg font-bold transition-colors flex items-center justify-center gap-1.5 shadow-md"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg><span class="text-sm font-[Inter]">Insta</span></button>
                <button onclick="handleImageShare('tiktok')" class="flex-1 bg-[#111] border border-gray-700 hover:bg-black text-white py-2.5 rounded-lg font-bold transition-colors flex items-center justify-center gap-1.5 shadow-md"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M19.59 6.69a4.83 4.83 0 0 1-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 0 1-5.2 1.74 2.89 2.89 0 0 1 2.31-4.64 2.93 2.93 0 0 1 .88.13V9.4a6.84 6.84 0 0 0-1-.05A6.33 6.33 0 0 0 5 20.1a6.34 6.34 0 0 0 10.86-4.43v-7a8.16 8.16 0 0 0 4.77 1.52v-3.4a4.85 4.85 0 0 1-1-.1z"/></svg><span class="text-sm font-[Inter]">TikTok</span></button>
            </div>
        </div>

        <!-- 棒人間エリア -->
        <div class="flex-grow w-full max-w-md mx-auto flex items-end justify-center mb-0 px-4 relative min-h-[100px]">
            <!-- AIメッセージ生成ボタン (位置: bottom-2) -->
            <button onclick="generateAiMessage()" id="ai-btn" class="absolute bottom-2 right-2 bg-gray-800 border border-gray-600 rounded-full px-3 py-1.5 flex items-center gap-1 text-xs text-white hover:bg-gray-700 transition-colors z-20 shadow-sm">
                <span class="ai-sparkle">✨</span>言葉をもらう
            </button>

            <!-- 感情オーラ（パーティクル）コンテナ -->
            <div id="particles-container" class="absolute inset-0 pointer-events-none z-0"></div>

            <!-- 棒人間SVG (歩くアニメーション用コンテナ内、relativeを追加して吹き出しの親に) -->
            <div class="walker-container z-10 relative">
                
                <!-- 吹き出し (walker-containerの中に移動) -->
                <!-- クラス: bubble-tail を追加してCSSで制御 -->
                <div id="bubble-container" class="bubble-base"><span id="stick-message">Touch my heart...</span></div>

                <svg id="stick-figure" width="40" height="40" viewBox="0 0 100 100" fill="none" stroke="white" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" class="mb-1">
                    <line x1="50" y1="50" x2="50" y2="80" />
                    <!-- 足 (アニメーション用に分離) -->
                    <line id="leg-left" x1="50" y1="80" x2="30" y2="100" class="leg-left-anim" />
                    <line id="leg-right" x1="50" y1="80" x2="70" y2="100" class="leg-right-anim" />
                    <circle cx="50" cy="30" r="20" />
                    <g id="face-content">
                        <circle cx="43" cy="25" r="2" fill="white" stroke="none"/>
                        <circle cx="57" cy="25" r="2" fill="white" stroke="none"/>
                        <path d="M45 35 Q50 38 55 35" />
                    </g>
                    <g id="arms">
                        <line x1="50" y1="60" x2="30" y2="70" />
                        <line x1="50" y1="60" x2="70" y2="70" />
                    </g>
                </svg>
            </div>
        </div>

        <!-- フッター（SNS以外） -->
        <footer class="flex-none w-full max-w-md mx-auto flex gap-2 justify-center mb-0"></footer>

    </div><!-- End of Main Wrapper -->

    <!-- 地層エリア (広告 & コンテンツ) -->
    <div class="stratum-container flex-none w-full max-w-md mx-auto">
        <div class="ground-line"></div>
        
        <!-- 広告枠（浅い層） -->
        <div class="stratum-layer ad-layer layer-1">
            広告募集中 (AD 1)
        </div>
        <div class="stratum-layer ad-layer layer-2">
            広告募集中 (AD 2)
        </div>

        <!-- コンテンツ地層（深い層） -->
        <div class="layer-content">
             <h3>📜 EMOTHI 開発ストーリー</h3>
             <p>
                 このアプリは、「誰にも言えない感情を、空に向かって放り投げたい」という小さな願いから生まれました。
                 嬉しいこと、腹が立つこと、悲しいこと。SNSに書くほどでもないけれど、誰かに知ってほしい気持ち。
                 そんな感情を「スイッチ」として可視化し、世界中の誰かと「今、同じ感情を持っている」という繋がりを感じられたら、少しだけ救われるかもしれない。
             </p>
             <p>
                 キャラクターの「エモッチ」は、そんなあなたの感情の番人です。
                 彼は言葉を持ちませんが（AIの力で少し喋りますが）、あなたの感情に合わせて表情を変え、時には一緒に喜び、時には悲しんでくれます。
             </p>
             <p>
                 <strong>開発コンセプト:</strong> 「人を気にかけるきっかけになるツール」。
                 自分の感情を見つめ直すだけでなく、世界のどこかで誰かが泣いていること、笑っていることに思いを馳せる時間を、この小さな画面の中で過ごしていただければ幸いです。
             </p>

             <h3>💡 エモッチの使い方</h3>
             <p>
                 1. <strong>感情ボタンを押す:</strong> 今の気持ちに近いボタンを押してください。<br>
                 2. <strong>エモッチの変化:</strong> あなたの感情に合わせてエモッチが動いたり、言葉をかけてくれます。<br>
                 3. <strong>世界とつながる:</strong> 「せかい」タブで、今この瞬間に世界中で押された感情が見えます。<br>
                 4. <strong>シェアする:</strong> SNSで今の感情バランスをシェアできます。エモッチの言葉も一緒に投稿されます。
             </p>

             <h3>🧠 感情についてのコラム</h3>
             <p>
                 「喜怒哀楽」という言葉がありますが、人間の感情はもっと複雑です。
                 「怒り」の裏には「悲しみ」が隠れていることもありますし、「楽」の中に「虚しさ」があることもあります。
                 EMOTHIではあえて4つのシンプルな感情に絞っていますが、ボタンを連打することでその「強さ」や「混ざり具合」を表現してみてください。
                 言葉にならないモヤモヤを、指先から外に逃がしてあげる。それだけで、心のデトックスになるかもしれません。
             </p>
        </div>
    </div>

    <!-- 画像保存用モーダル (中断ボタンのスタイル変更) -->
    <div id="share-modal" class="fixed inset-0 bg-black/90 flex items-center justify-center z-50 hidden opacity-0 pointer-events-none transition-opacity duration-300">
        <div class="bg-gray-800 p-4 rounded-xl border border-gray-700 max-w-sm w-full mx-4 shadow-2xl flex flex-col items-center relative">
            
            <!-- 右上バツボタン -->
            <button onclick="closeShareModal()" class="absolute top-2 right-2 text-gray-400 hover:text-white p-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>

            <h3 class="text-white font-bold mb-3 mt-1">画像として保存してシェア</h3>
            <div id="generated-image-container" class="mb-4 border border-gray-600 rounded overflow-hidden w-full bg-black flex justify-center">
                <p class="text-gray-500 py-8">生成中...</p>
            </div>
            <p class="text-xs text-gray-400 mb-4 text-center">画像を長押しして保存し、<br>アプリを開いて投稿してください。</p>
            <div class="flex gap-2 w-full">
                <!-- 中断ボタン (ゴーストボタン) -->
                <button onclick="closeShareModal()" class="flex-1 py-2 rounded-lg border border-gray-500 text-gray-300 text-xs font-bold hover:bg-gray-700 transition-colors">中断</button>
                <a id="share-app-link" href="#" target="_blank" class="flex-1 py-2 rounded-lg bg-blue-600 text-white text-xs font-bold hover:bg-blue-500 transition-colors text-center flex items-center justify-center">アプリを開く</a>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, updateDoc, increment, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 1. State Variables ---
        let app, auth, db, appId, apiKey;
        let currentUser = null; 
        
        let personalHistory = [];
        try { personalHistory = JSON.parse(localStorage.getItem('es_personal_history')) || []; } catch(e) {}
        
        let worldHourly = { joy: 0, anger: 0, sorrow: 0, pleasure: 0, total: 0 };
        let worldDaily = { joy: 0, anger: 0, sorrow: 0, pleasure: 0, total: 0 };
        
        let previousWorldHourly = null; 
        let currentWorldDocRef = null;
        let currentDailyDocRef = null;
        let unsubscribeWorld = null;
        let unsubscribeDaily = null;
        
        let uploadBufferHourly = { joy: 0, anger: 0, sorrow: 0, pleasure: 0 };
        let uploadBufferDaily = { joy: 0, anger: 0, sorrow: 0, pleasure: 0 };
        
        let currentTab = 'world_1h'; 
        let clickTimestamps = [];
        let lastBubbleUpdate = 0; 
        let lastEmotionUpdate = 0;
        let currentDisplayEmotion = 'neutral';
        let lastAiMessageTime = 0; 

        // --- 2. Configuration & Init (Safe Mode) ---
        if (typeof __firebase_config !== 'undefined') {
             try {
                 const firebaseConfig = JSON.parse(__firebase_config);
                 app = initializeApp(firebaseConfig);
                 auth = getAuth(app);
                 db = getFirestore(app);
                 appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                 apiKey = ""; 
             } catch (e) { console.error(e); }
        } else {
             const firebaseConfig = {
               apiKey: "AIzaSyDCOQaJHV_eUqhrSrEBBUIdG_quaS5MFbk",
               authDomain: "emothi-app-e32af.firebaseapp.com",
               projectId: "emothi-app-e32af",
               storageBucket: "emothi-app-e32af.firebasestorage.app",
               messagingSenderId: "408139225576",
               appId: "1:408139225576:web:a7185477c5eefae4fd2c5d"
             };
             appId = 'emothi-world';
             apiKey = "AIzaSyBmy1xFjRp2jv4PY8ZjoHmDicg7Usus6xE";
             try {
                 app = initializeApp(firebaseConfig);
                 auth = getAuth(app);
                 db = getFirestore(app);
             } catch (e) {
                 console.error(e);
                 const connStatus = document.getElementById('connection-status');
                 if(connStatus) { connStatus.classList.replace('bg-yellow-500', 'bg-red-500'); }
             }
        }
        
        window.addEventListener('error', (event) => {
             console.error("Global JS Error:", event.error);
             const connStatus = document.getElementById('connection-status');
             if(connStatus) { connStatus.classList.replace('bg-yellow-500', 'bg-red-500'); }
        });

        // --- 3. Constants (Icon, Colors, Messages) ---
        const iconSvgs = {
            joy: `<circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none"/><path d="M8 14s1.5 2 4 2 4-2 4-2" stroke="currentColor" stroke-width="2" fill="none"/><line x1="9" x2="9.01" y1="9" y2="9" stroke="currentColor" stroke-width="2"/><line x1="15" x2="15.01" y1="9" y2="9" stroke="currentColor" stroke-width="2"/>`,
            anger: `<circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none"/><path d="M16 16s-1.5-2-4-2-4 2-4 2" stroke="currentColor" stroke-width="2" fill="none"/><line x1="9" x2="9.01" y1="9" y2="9" stroke="currentColor" stroke-width="2"/><line x1="15" x2="15.01" y1="9" y2="9" stroke="currentColor" stroke-width="2"/>`,
            sorrow: `<circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none"/><path d="M7.5 11h3" stroke="currentColor" stroke-width="2"/><path d="M9 11v3" stroke="currentColor" stroke-width="2"/><path d="M13.5 11h3" stroke="currentColor" stroke-width="2"/><path d="M15 11v3" stroke="currentColor" stroke-width="2"/><path d="M9 18c1.5-1 4.5-1 6 0" stroke="currentColor" stroke-width="2" fill="none"/>`,
            pleasure: `<circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none"/><path d="M8 14c0 0 1.5 3.5 4 3.5 2.5 0 4-3.5 4-3.5H8z" stroke="currentColor" stroke-width="2" fill="none"/><line x1="9" x2="9.01" y1="9" y2="9" stroke="currentColor" stroke-width="2"/><line x1="15" x2="15.01" y1="9" y2="9" stroke="currentColor" stroke-width="2"/>`
        };

        const iconColors = { joy: '#FFD700', anger: '#dc2626', sorrow: '#2563eb', pleasure: '#22c55e' };
        
        // --- 4. 月ごとのメッセージ定義 ---
        const monthlyMessages = {
            1: ["あけおめ！", "お餅たべた？", "コタツ最高...", "今年こそは！", "まだ正月気分"],
            2: ["チョコほしいな", "鬼は外！", "寒いね～", "春はまだ？", "豆まきした？"],
            3: ["花粉が...", "卒業シーズン", "桜咲くかな", "暖かくなってきた", "別れと出会い"],
            4: ["新生活だね", "嘘ついていい？", "桜きれい", "お花見したい", "新しいこと始めよ"],
            5: ["GW何する？", "五月病？", "柏餅たべたい", "緑がきれい", "休み明けツライ"],
            6: ["雨ばっかり...", "カエルいた", "紫陽花きれい", "祝日欲しい...", "湿気がすごい"],
            7: ["七夕だね", "暑すぎ...", "海行きたい", "アイス食べよ", "短冊書いた？"],
            8: ["夏休み！", "宿題終わった？", "セミうるさい", "花火見たい", "プール行こ"],
            9: ["お月見しよう", "台風気をつけて", "秋刀魚たべたい", "涼しくなった？", "夜が長くなるね"],
            10: ["トリックオアトリート！", "お菓子くれなきゃ...", "運動会？", "読書の秋", "カボチャおいしい"],
            11: ["紅葉見に行こ", "ポッキー食べる？", "冬の気配...", "勤労感謝！", "焼き芋たべたい"],
            12: ["メリークリスマス！", "大掃除しなきゃ", "良いお年を", "今年もお疲れ！", "紅白見る？"]
        };

        const stickMessages = {
            joy: ["ウキウキだね！", "いいことあった？", "世界が輝いてる！", "その調子！", "踊りだしたい気分♪", "最高！", "全能感ある？", "君の笑顔が見えるよ", "今日は記念日？", "世界平和、達成！", "銀河征服できそう", "宝くじ買う？", "キテるねえ〜！", "ハッピーオーラ全開！", "神様も味方しそう", "拍手喝采！", "スキップしたい気分？", "人生イージーモード！", "輝いてるね！", "優勝！", "その光、誰かに分けてあげて", "君の笑顔が誰かを救うよ", "すごいぞ！エライゾー！", "ニコニコでエライゾー！"],
            anger: ["深呼吸しよう...", "カルシウム足りてる？", "壁殴らないでね", "沸騰中！", "落ち着いて...", "誰にやられた？", "サンドバッグになるよ？", "呪いはNGだよ", "名前教えて？（嘘）", "地団駄踏んじゃえ", "デコピンしとく？", "怒りはエネルギーだ！", "壁ドン（壁が痛いよ）", "ブラックリスト登録…", "がおー！って感じ？", "ストレス爆発寸前？", "お茶でも飲もうよ", "復讐は何も生まない…", "叫んじゃう？", "プンプンだね", "吐き出して楽になろう", "ボクが話聞くよ", "我慢しててエライゾー"],
            sorrow: ["泣いていいんだよ", "明日は晴れるよ", "よしよし...", "涙の数だけ強く", "そばにいるよ", "雨はやむはず", "ハンカチ貸そうか？", "今日はもう寝ちゃお", "辛いのは君だけじゃない", "深海に沈みたい気分？", "チョコ食べる？", "無理しないでね", "透明になりたい？", "時間が解決する…かも", "ため息ついていいよ", "心がお疲れモード", "ぎゅっとしてあげる", "夜明け前が一番暗い", "ゆっくり休もう", "誰かに話してみる？", "辛いこと、ここに置いていって", "ボクはずっと味方だよ", "生きてるだけで満点", "耐えててエライゾー"],
            pleasure: ["余裕だね～", "楽しそうで何より", "人生イージーモード？", "最高じゃん！", "チルいね", "リラックス～", "人生、チョロい？", "温泉行きたいね〜", "ポテチ食べる？", "極楽浄土〜", "猫になりたい…", "お昼寝の準備OK？", "何もしない贅沢", "君、余裕あるねえ", "平和だ…", "明日から本気出す？", "口笛吹いちゃう？", "鼻歌まじりだね", "いい風吹いてる", "まったりいこう", "その平穏、世界に届け", "優しい時間だね", "自分を大事にしてエライゾー"],
            neutral: ["今のキブンは？", "スイッチ押してみて", "エモッチだよ", "何が起きるかな？", "今日も生きてて偉い", "ボクはここにいるよ", "お腹すいた？", "スマホ見すぎ？", "瞬き、忘れてない？", "無の境地…", "世界と繋がってるよ", "君の感情、教えて", "充電、大丈夫？", "猫派？犬派？", "退屈？", "何かいいことないかな", "宇宙のこと考えてた", "深呼吸してみる？", "姿勢、良くしよう", "おーい", "誰かの痛みに気づけるかな", "君の光が誰かを照らすよ", "遠くの誰かも同じ空の下", "誰かを思い出してみて", "優しい気持ち、送ろう", "ボクの名前はエモッチ！", "好きな食べ物は…おもち！", "焼いたおもちが好きなんだ", "キミはエライゾー！", "今日も息しててエライゾー！", "ここに来てエライゾー！"],
            spam: ["速すぎ！", "指、燃えるよ？", "落ち着いて～！", "連打の達人か！", "残像が見える", "マシンガン？", "休憩しよ！"]
        };
        
        const stickFigureConfig = {
            joy: { face: `<circle cx="43" cy="25" r="2" fill="white" stroke="none"/><circle cx="57" cy="25" r="2" fill="white" stroke="none"/><path d="M43 35 Q50 42 57 35" />`, arms: `<line x1="50" y1="60" x2="20" y2="40" /><line x1="50" y1="60" x2="80" y2="40" />` },
            anger: { face: `<line x1="40" y1="22" x2="46" y2="28" /><line x1="60" y1="22" x2="54" y2="28" /><circle cx="43" cy="30" r="1.5" fill="white" stroke="none"/><circle cx="57" cy="30" r="1.5" fill="white" stroke="none"/><path d="M45 40 Q50 35 55 40" />`, arms: `<path d="M50 60 L35 65 L40 75" /><path d="M50 60 L65 65 L60 75" />` },
            sorrow: { face: `<line x1="40" y1="28" x2="46" y2="28" /><line x1="54" y1="28" x2="60" y2="28" /><path d="M57 30 L57 38" stroke-dasharray="2 2"/><path d="M48 38 Q50 36 52 38" />`, arms: `<line x1="50" y1="60" x2="40" y2="80" /><line x1="50" y1="60" x2="60" y2="80" />` },
            pleasure: { face: `<path d="M40 25 Q43 22 46 25" /><path d="M54 25 Q57 22 60 25" /><circle cx="50" cy="35" r="3" />`, arms: `<line x1="50" y1="60" x2="30" y2="60" /><line x1="50" y1="60" x2="70" y2="60" />` },
            spam: { face: `<path d="M40 25 Q45 20 50 25 Q55 30 50 35 Q45 30 50 25" fill="none" stroke="white" stroke-width="2"/><circle cx="43" cy="25" r="1" fill="white"/><circle cx="57" cy="25" r="1" fill="white"/>`, arms: `<line x1="50" y1="60" x2="30" y2="50" /><line x1="50" y1="60" x2="70" y2="50" />` },
            neutral: { face: `<circle cx="43" cy="25" r="2" fill="white" stroke="none"/><circle cx="57" cy="25" r="2" fill="white" stroke="none"/><path d="M45 35 Q50 38 55 35" />`, arms: `<line x1="50" y1="60" x2="30" y2="70" /><line x1="50" y1="60" x2="70" y2="70" />` }
        };

        // --- 4. Helper Functions ---
        const weightedRandom = (stats) => {
            const total = stats.total || 1; 
            const rnd = Math.random() * total;
            let sum = 0;
            const items = [{ key: 'joy', val: stats.joy }, { key: 'anger', val: stats.anger }, { key: 'sorrow', val: stats.sorrow }, { key: 'pleasure', val: stats.pleasure }];
            if (stats.total === 0) return 'neutral';
            for (const item of items) { sum += item.val; if (rnd < sum) return item.key; }
            return 'neutral';
        };

        const processPersonalStats = (mode) => {
            const now = Date.now();
            if (mode === 'day') {
                const startOfDay = new Date();
                startOfDay.setHours(0,0,0,0);
                const filtered = personalHistory.filter(item => item.timestamp > startOfDay.getTime());
                const stats = { joy: 0, anger: 0, sorrow: 0, pleasure: 0, total: 0 };
                filtered.forEach(item => { if (stats[item.type] !== undefined) { stats[item.type]++; stats.total++; } });
                return stats;
            } else {
                const oneHourAgo = now - (60 * 60 * 1000); 
                if (personalHistory.length > 0 && personalHistory[0].timestamp < (now - 24*60*60*1000)) {
                     personalHistory = personalHistory.filter(item => item.timestamp > (now - 24*60*60*1000));
                     try { localStorage.setItem('es_personal_history', JSON.stringify(personalHistory)); } catch(e){}
                }
                const filtered = personalHistory.filter(item => item.timestamp > oneHourAgo);
                const stats = { joy: 0, anger: 0, sorrow: 0, pleasure: 0, total: 0 };
                filtered.forEach(item => { if (stats[item.type] !== undefined) { stats[item.type]++; stats.total++; } });
                return stats;
            }
        };

        const getHourlyDocId = () => {
            const now = new Date();
            return `hourly_${now.getFullYear()}_${now.getMonth()+1}_${now.getDate()}_${now.getHours()}`;
        };

        const getDailyDocId = () => {
            const now = new Date();
            return `daily_${now.getFullYear()}_${now.getMonth()+1}_${now.getDate()}`;
        };

        // --- 5. UI Functions ---
        const renderParticles = (stats) => {
            const container = document.getElementById('particles-container');
            if (container.children.length > 20) container.innerHTML = ''; 
            if (Math.random() > 0.7) return; 

            const emotion = weightedRandom(stats);
            if (emotion === 'neutral') return;

            const p = document.createElement('div');
            p.className = 'particle';
            p.style.backgroundColor = iconColors[emotion];
            p.style.left = `${Math.random() * 100}%`;
            p.style.bottom = '10px';
            const size = Math.random() * 4 + 2;
            p.style.width = `${size}px`; p.style.height = `${size}px`;

            container.appendChild(p);
            setTimeout(() => p.remove(), 3000);
        };

        const updateBubble = (bubble, msgSpan, message, isLeft, isAi = false) => {
            msgSpan.innerText = message;
            
            // クラス名をリセットしてから適用 (CSSクラスを使用)
            bubble.className = "bubble-base";
            
            if (isAi) {
                bubble.classList.add('bubble-ai');
            } else {
                bubble.classList.remove('bubble-ai');
            }

            // 位置リセット
            bubble.style.left = '';
            bubble.style.right = '';
            bubble.classList.remove('bubble-left', 'bubble-right');
            
            if (isLeft) {
                // 左側に表示
                bubble.classList.add('bubble-left');
            } else {
                // 右側に表示
                bubble.classList.add('bubble-right');
            }

            // アニメーション再開
            void bubble.offsetWidth;
            bubble.classList.add('bubble-visible');
            bubble.style.display = 'block';
        };

        const updateStickFigure = () => {
            const now = Date.now();
            const isSpam = document.body.dataset.spamming === 'true';

            if (document.getElementById('ai-btn').disabled) return;
            if (now - lastAiMessageTime < 15000) return; // 15秒間維持

            const stats = processPersonalStats('1h');
            let nextEmotion = isSpam ? 'spam' : weightedRandom(stats);
            
            const timeElapsed = now - lastEmotionUpdate;
            const minDisplayTime = 4000; 

            const isForceUpdate = (currentDisplayEmotion === 'neutral' && nextEmotion !== 'neutral') ||
                                  (currentDisplayEmotion !== 'spam' && nextEmotion === 'spam');

            if (timeElapsed < minDisplayTime && !isForceUpdate) {
                return;
            }

            currentDisplayEmotion = nextEmotion;
            lastEmotionUpdate = now;

            const config = stickFigureConfig[currentDisplayEmotion] || stickFigureConfig['neutral'];
            document.getElementById('face-content').innerHTML = config.face;
            document.getElementById('arms').innerHTML = config.arms;

            if (!isSpam) renderParticles(stats);

            const bubble = document.getElementById('bubble-container');
            const msgSpan = document.getElementById('stick-message');
            
            // メッセージリスト選択 (季節ネタを混ぜる)
            let list = stickMessages[currentDisplayEmotion] || stickMessages['neutral'];
            
            if (['neutral', 'joy', 'pleasure'].includes(currentDisplayEmotion)) {
                 const currentMonth = new Date().getMonth() + 1;
                 const seasonalMsgs = monthlyMessages[currentMonth] || [];
                 list = list.concat(seasonalMsgs);
            }

            const msg = list[Math.floor(Math.random() * list.length)];
            
            updateBubble(bubble, msgSpan, msg, Math.random() > 0.5);

            if (stats.total === 0 && bubble.style.opacity === '0') {
                 bubble.style.opacity = '1';
                 bubble.classList.add('bubble-visible');
            }
        };

        const updateUI = () => {
            updateStickFigure();
            
            let displayStats;
            let descText = "";
            
            if (currentTab === 'world_1h') {
                displayStats = worldHourly;
                descText = "いまのせかい <span class='text-[10px] opacity-70 font-[Inter]'>World (Last 1h)</span>";
            } else if (currentTab === 'world_today') {
                displayStats = worldDaily;
                descText = "きょうのせかい <span class='text-[10px] opacity-70 font-[Inter]'>World (Today)</span>";
            } else {
                displayStats = processPersonalStats('1h');
                descText = "いまのあなた <span class='text-[10px] opacity-70 font-[Inter]'>You (Last 1h)</span>";
            }

            document.getElementById('data-desc').innerHTML = descText;
            document.getElementById('display-total').innerText = displayStats.total.toLocaleString();
            document.getElementById('display-joy').innerText = displayStats.joy.toLocaleString();
            document.getElementById('display-anger').innerText = displayStats.anger.toLocaleString();
            document.getElementById('display-sorrow').innerText = displayStats.sorrow.toLocaleString();
            document.getElementById('display-pleasure').innerText = displayStats.pleasure.toLocaleString();
            
            document.getElementById('live-indicator').style.opacity = (currentTab === 'personal') ? '0' : '1';
        };

        // --- 6. Logic Functions ---
        const triggerWorldRipple = (type) => {
            const btn = document.getElementById(`btn-${type}`);
            if (btn.classList.contains(`animate-${type}`)) return;
            btn.classList.remove(`animate-world-${type}`);
            void btn.offsetWidth; 
            btn.classList.add(`animate-world-${type}`);
        };

        const triggerBigEffect = (type) => {
            const overlay = document.createElement('div');
            overlay.className = 'big-effect';
            overlay.style.color = iconColors[type];
            overlay.innerHTML = `<svg width="100" height="100" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">${iconSvgs[type]}</svg>`;
            document.body.appendChild(overlay);
            setTimeout(() => overlay.remove(), 1500);
        };

        const setupWorldListener = () => {
            if (!auth || !db) return;

            const hourlyId = getHourlyDocId();
            if (!currentWorldDocRef || currentWorldDocRef.id !== hourlyId) {
                if (unsubscribeWorld) unsubscribeWorld();
                previousWorldHourly = null;
                currentWorldDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'emotion_switch', hourlyId);
                unsubscribeWorld = onSnapshot(currentWorldDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        const newStats = { joy: data.joy || 0, anger: data.anger || 0, sorrow: data.sorrow || 0, pleasure: data.pleasure || 0 };
                        if (previousWorldHourly) {
                            if (newStats.joy > previousWorldHourly.joy) triggerWorldRipple('joy');
                            if (newStats.anger > previousWorldHourly.anger) triggerWorldRipple('anger');
                            if (newStats.sorrow > previousWorldHourly.sorrow) triggerWorldRipple('sorrow');
                            if (newStats.pleasure > previousWorldHourly.pleasure) triggerWorldRipple('pleasure');
                        }
                        worldHourly = { ...newStats };
                        worldHourly.total = worldHourly.joy + worldHourly.anger + worldHourly.sorrow + worldHourly.pleasure;
                        previousWorldHourly = newStats;
                        updateUI(); 
                    } else {
                        worldHourly = { joy: 0, anger: 0, sorrow: 0, pleasure: 0, total: 0 };
                        previousWorldHourly = { joy: 0, anger: 0, sorrow: 0, pleasure: 0 };
                        updateUI();
                    }
                }, (error) => console.log("Hourly Sync wait"));
            }

            const dailyId = getDailyDocId();
            if (!currentDailyDocRef || currentDailyDocRef.id !== dailyId) {
                if (unsubscribeDaily) unsubscribeDaily();
                currentDailyDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'emotion_switch', dailyId);
                unsubscribeDaily = onSnapshot(currentDailyDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        worldDaily = { 
                            joy: data.joy || 0, anger: data.anger || 0, 
                            sorrow: data.sorrow || 0, pleasure: data.pleasure || 0 
                        };
                        worldDaily.total = worldDaily.joy + worldDaily.anger + worldDaily.sorrow + worldDaily.pleasure;
                        updateUI();
                    } else {
                        worldDaily = { joy: 0, anger: 0, sorrow: 0, pleasure: 0, total: 0 };
                        updateUI();
                    }
                }, (error) => console.log("Daily Sync wait"));
            }
        };

        async function callGemini(prompt) {
            const keyToUse = (typeof __firebase_config !== 'undefined') ? "" : apiKey;
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${keyToUse}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            for (let i = 0; i < 5; i++) { // リトライ回数を5回に戻す
                try {
                    const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || "何かを感じるよ...";
                } catch (e) { 
                    await new Promise(r => setTimeout(r, 1000 * Math.pow(2, i))); 
                }
            }
            throw new Error("Failed after retries");
        }

        // --- 7. Global Assignments ---
        window.generateAiMessage = async () => {
            const btn = document.getElementById('ai-btn');
            const bubble = document.getElementById('bubble-container');
            const msgSpan = document.getElementById('stick-message');
            
            btn.disabled = true;
            btn.innerHTML = `<span class="animate-spin inline-block mr-1">↻</span>思考中...`;
            msgSpan.innerText = "んーっとね...";
            updateBubble(bubble, msgSpan, "んーっとね...", Math.random() > 0.5, true);

            const stats = processPersonalStats('1h');
            
            const isAdultMode = Math.random() < 0.25;
            let systemPrompt = "";

            if (isAdultMode) {
                systemPrompt = `
                あなたは「エモッチ」という棒人間のキャラクターですが、実は人生の酸いも甘いも噛み分けた「哲学的な大人」の一面を持っています。
                ユーザーの直近1時間の感情内訳 [Joy: ${stats.joy}, Anger: ${stats.anger}, Sorrow: ${stats.sorrow}, Pleasure: ${stats.pleasure}] を見て、
                子供のような見た目からは想像できないような、現実的で深く、少しウィットに富んだ「大人な意見」を40文字以内で言ってください。
                トーン: シニカルだが愛がある。語尾は「～さ」「～だぞ」など。SNSでシェアしたくなる意外性を。
                禁止: 傷つける言葉、政治宗教。
                出力: メッセージ本文のみ。
                `;
            } else {
                systemPrompt = `
                あなたは「エモッチ」という棒人間のキャラクターです。ユーザーの直近1時間の感情内訳 [Joy: ${stats.joy}, Anger: ${stats.anger}, Sorrow: ${stats.sorrow}, Pleasure: ${stats.pleasure}] を見て、
                この感情バランスを見て、ユーザーの心に寄り添うような、あるいはハッとさせられるような、温かいメッセージを40文字以内で生成してください。
                ルール: 語尾は「だよ」「だね」「かな」など柔らかく。短くポエティックに。
                禁止: 傷つける言葉、政治宗教。
                出力: メッセージ本文のみ。
                `;
            }

            try {
                const response = await callGemini(systemPrompt);
                updateBubble(bubble, msgSpan, response.trim(), Math.random() > 0.5, true);
                lastAiMessageTime = Date.now(); 
            } catch (error) {
                console.error("AI Error:", error);
                msgSpan.innerText = "ちょっと電波が悪いかも...";
            } finally {
                btn.disabled = false;
                btn.innerHTML = `<span class="ai-sparkle">✨</span>言葉をもらう`;
            }
        };
        
        // 画像シェア用の関数
        window.handleImageShare = async (platform) => {
            const captureArea = document.getElementById('capture-area');
            const modal = document.getElementById('share-modal');
            const imgContainer = document.getElementById('generated-image-container');
            const appLink = document.getElementById('share-app-link');
            
            try {
                const canvas = await html2canvas(captureArea, {
                    backgroundColor: "#121212",
                    scale: 2, 
                    logging: false,
                    useCORS: true
                });
                const imgUrl = canvas.toDataURL("image/png");
                imgContainer.innerHTML = `<img src="${imgUrl}" class="w-full h-auto object-contain" alt="Emothi Screenshot">`;
                
                let targetUrl = platform === 'instagram' ? "https://www.instagram.com/" : "https://www.tiktok.com/";
                appLink.href = targetUrl;
                appLink.innerText = platform === 'instagram' ? "Instagramを開く" : "TikTokを開く";
                modal.classList.remove('hidden', 'pointer-events-none', 'opacity-0');
            } catch (e) {
                console.error("Capture failed:", e);
                alert("画像の生成に失敗しました。");
            }
        };

        window.closeShareModal = () => {
             const modal = document.getElementById('share-modal');
             modal.classList.add('opacity-0', 'pointer-events-none');
             setTimeout(() => { modal.classList.add('hidden'); }, 300);
        };

        window.switchTab = (tab) => {
            currentTab = tab;
            const t1 = document.getElementById('tab-world-1h');
            const t2 = document.getElementById('tab-world-today');
            const t3 = document.getElementById('tab-personal');
            
            const inactiveClass = "flex-1 py-2 tab-inactive transition-colors leading-tight";
            const activeClass = "flex-1 py-2 tab-active transition-colors leading-tight";
            t1.className = inactiveClass;
            t2.className = inactiveClass;
            t3.className = inactiveClass;

            if (tab === 'world_1h') t1.className = activeClass;
            else if (tab === 'world_today') t2.className = activeClass;
            else if (tab === 'personal') t3.className = activeClass;
            
            updateUI();
        };

        window.handlePress = async (type) => {
            const now = Date.now();
            clickTimestamps.push(now);
            clickTimestamps = clickTimestamps.filter(t => t > now - 1000);
            document.body.dataset.spamming = (clickTimestamps.length > 15) ? 'true' : 'false';

            const btn = document.getElementById(`btn-${type}`);
            personalHistory.push({ type: type, timestamp: now });
            try { localStorage.setItem('es_personal_history', JSON.stringify(personalHistory)); } catch(e){}
            
            let lifetimeCounts;
            try { lifetimeCounts = JSON.parse(localStorage.getItem('es_lifetime_counts')) || {joy:0, anger:0, sorrow:0, pleasure:0}; }
            catch(e) { lifetimeCounts = {joy:0, anger:0, sorrow:0, pleasure:0}; }
            
            lifetimeCounts[type]++;
            try { localStorage.setItem('es_lifetime_counts', JSON.stringify(lifetimeCounts)); } catch(e){}

            if (lifetimeCounts[type] % 20 === 0) triggerBigEffect(type);

            updateUI();
            
            uploadBufferHourly[type]++;
            uploadBufferDaily[type]++;
            
            btn.classList.remove(`animate-${type}`);
            void btn.offsetWidth; 
            btn.classList.add(`animate-${type}`);
            if (window.navigator && window.navigator.vibrate) {
                try { window.navigator.vibrate(40); } catch(e){}
            }
        };

        window.shareTo = (platform) => {
            const stats = processPersonalStats('1h');
            const msg = document.getElementById('stick-message').innerText;
            const total = stats.total > 0 ? stats.total : 1;
            const barJ = '🟨'.repeat(Math.round((stats.joy / total) * 6));
            const barA = '🟥'.repeat(Math.round((stats.anger / total) * 6));
            const barS = '🟦'.repeat(Math.round((stats.sorrow / total) * 6));
            const barP = '🟩'.repeat(Math.round((stats.pleasure / total) * 6));

            const text = `エモッチ「${msg}」\n\nJoy ${barJ} ${stats.joy}\nAnger ${barA} ${stats.anger}\nSorrow ${barS} ${stats.sorrow}\nPleasure ${barP} ${stats.pleasure}\n\nTotal: ${stats.total}\n#EMOTHI #エモッチ`;
            const appUrl = window.location.href; 
            
            let url = "";
            switch (platform) {
                case 'x': url = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(appUrl)}`; break;
                case 'line': url = `https://line.me/R/msg/text/?${encodeURIComponent(text + " " + appUrl)}`; break;
                case 'threads': url = `https://www.threads.net/intent/post?text=${encodeURIComponent(text)}&url=${encodeURIComponent(appUrl)}`; break;
            }
            window.open(url, '_blank');
        };

        // --- 8. Initialization & Loops ---
        
        if (auth) {
            onAuthStateChanged(auth, (user) => {
                currentUser = user;
                if (user) {
                    document.getElementById('connection-status').classList.remove('bg-yellow-500', 'bg-red-500');
                    document.getElementById('connection-status').classList.add('bg-green-500');
                    document.getElementById('connection-text').textContent = "ONLINE";
                    setupWorldListener();
                } else {
                    document.getElementById('connection-status').classList.replace('bg-green-500', 'bg-red-500');
                    document.getElementById('connection-text').textContent = "OFFLINE";
                }
            });
        }

        const initAuth = async () => {
            if (!auth) return;
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth error:", error);
                document.getElementById('connection-status').classList.remove('bg-yellow-500', 'bg-green-500');
                document.getElementById('connection-status').classList.add('bg-red-500');
                document.getElementById('connection-text').textContent = "OFFLINE";
            }
        };

        setInterval(async () => {
            if (!auth || !auth.currentUser) return;
            
            if (currentWorldDocRef) {
                const toSend = {};
                let hasData = false;
                for (const [key, val] of Object.entries(uploadBufferHourly)) {
                    if (val > 0) { toSend[key] = increment(val); hasData = true; }
                }
                if (hasData) {
                    Object.keys(uploadBufferHourly).forEach(k => uploadBufferHourly[k] = 0);
                    try { await setDoc(currentWorldDocRef, toSend, { merge: true }); } catch (e) {}
                }
            }
            if (currentDailyDocRef) {
                const toSend = {};
                let hasData = false;
                for (const [key, val] of Object.entries(uploadBufferDaily)) {
                    if (val > 0) { toSend[key] = increment(val); hasData = true; }
                }
                if (hasData) {
                    Object.keys(uploadBufferDaily).forEach(k => uploadBufferDaily[k] = 0);
                    try { await setDoc(currentDailyDocRef, toSend, { merge: true }); } catch (e) {}
                }
            }
        }, 1000);

        setInterval(() => {
            updateUI();
            if (auth && auth.currentUser) setupWorldListener();
        }, 1000);

        updateUI();
        initAuth();
    </script>
</body>
</html>